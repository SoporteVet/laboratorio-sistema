<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Plantillas</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <body>
        <div class="controls">
            <label for="sexoSelector">Selecciona el sexo:</label>
            <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Macho">Macho</option>
                <option value="Hembra">Hembra</option>
            </select>
            <label for="especieSelector">Selecciona la especie:</label>
            <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Canino">Canino</option>
                <option value="Felino">Felino</option>
                <option value="Lagomorfo">Lagomorfo</option>
                <option value="Cuilo">Cuilo</option>
            </select>
            <label for="edadSelector">Selecciona el rango de edad:</label>
            <select id="edadSelector" onchange="actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="De 1 año a 12 años">De 1 año a 12 años</option>
                <option value="De 6 meses a 1 año">De 6 meses a 1 año</option>
                <option value="De 3 meses a 6 meses">De 3 meses a 6 meses</option>
                <option value="Todas las edades">Todas las edades</option>
            </select>
            
            <!-- NUEVO: Selector de plantilla -->
            <label for="plantillaSelector">Selecciona la plantilla:</label>
            <select id="plantillaSelector" onchange="cambiarPlantilla()">
                <option value="template1" selected>Análisis Completo</option>
                <option value="template2">Análisis General</option>
            </select>
        </div>
        <div class="container" id="template1" style="display: block;">
        <div class="header">
            <img src="img/empresa.jpg" alt="Logo de la Empresa" class="small-image">
            <h1>Laboratorio Clínico Veterinario</h1>
        </div>
        <h3 class="subheader">ANÁLISIS HECES COMPLETO</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre</td>
                        <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                        <td>Nombre</td>
                        <td><input type="text" id="propietarioNombre"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                    </tr>
                    <tr>
                        <td>Raza</td>
                        <td><input type="text" id="mascotaRaza" list="razas"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                        <datalist id="razas">

                        </datalist>
                        <td>Cédula</td>
                        <td><input type="text" id="propietarioCedula"  onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                    </tr>
                    <tr>
                        <td>Sexo</td>
                        <td><input type="text" id="sexoEnPlantilla"></td>
                        <td>Teléfono</td>
                        <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                    </tr>
                    <tr>
                        <td>Especie</td>
                        <td><input type="text" id="especieEnPlantilla"></td>
                        <td>Email</td>
                        <td><input type="text" id="propietarioEmail"  onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                    </tr>
                    <tr>
                        <td>Edad</td>
                        <td><input type="text" id="mascotaEdad" list="edades"  onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
    
                        <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                        <td>Médico</td>
                        <td>
                            <input type="text" id="nombreMedico" list="medicos" 
                                onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                                oninput="verificarMedico()">
                        </td>
                        <datalist id="medicos">
                            <option value="N.A">
                            <option value="Dr. Randall Azofeifa">
                            <option value="Dr. Luis Coto">
                            <option value="Dra. Daniela Sancho">
                            <option value="Dra. Sofia Carrillo">
                            <option value="Dra. Franciny Nuñez">
                            <option value="Dra. Maria Chacón">
                            <option value="Dra. Alejandra León">
                            <option value="Dra. Karla Quesada">
                            <option value="Dra. Kharen Moreno">
                            <option value="Dra. Karina Madrigal">
                            <option value="Dra. Natalia Alvarado">
                        </datalist>
                    </tr>
                    <tr>
                        <script>    
                            function actualizarSexoEnPlantilla() {
                                const sexo = document.getElementById('sexoSelector').value;
                                const sexoCapitalizado = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                                document.getElementById('sexoEnPlantilla').value = sexoCapitalizado;
                                document.getElementById('sexoEnPlantilla2').value = sexoCapitalizado;
                            }
                            function actualizarEspecieEnPlantilla() {
                                const especie = document.getElementById('especieSelector').value;
                                document.getElementById('especieEnPlantilla').value = especie;
                                document.getElementById('especieEnPlantilla2').value = especie;
                                actualizarRazasPorEspecie();
                            }
                            function verificarMedico() {
                                const medico = document.getElementById('nombreMedico').value;
                                const mensaje = document.getElementById('mensajeMedico');
                                if (medico === 'N.A' || medico === '') {
                                    mensaje.style.display = 'none';
                                } else {
                                    mensaje.style.display = 'block';
                                }
                            }
                            
            function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                            </script>
                    </tr>
                    <tr>
                        <td>Peso</td>
    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
    
        <datalist id="pesos">
            <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
            <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
            <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
            <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
            <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
            <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
            <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
            <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
            <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
            <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
            <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
            <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
            <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
            <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
            <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
            <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
            <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
            <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
            <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
            <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
            <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
            <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
            <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
            <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
            <option value="12,0 kg">12,0 kg</option>
            
        </datalist>
            <td>Fecha</td>
            <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                    </tr>
                    
                    <script>
                  function formatearFecha(input) {
                const fecha = new Date(input.value);
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const año = fecha.getFullYear();
                input.value = `${dia}-${mes}-${año}`;
            }
       
            function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                const razasCaninas = [
    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
    "San Bernardo", "Schnauzer", "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
];

const razasFelinas = [
    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
    "Silvestre", "SRD"
];
// Reemplazar la función de reemplazo de punto por coma
function reemplazarPuntoPorComa() {
    // Obtener todos los campos numéricos
    const camposNumericos = [
        'Glucosa', 'Colesterol_total', 'amilasa', 'CK', 
        'nitrogeno_ureico', 'urea', 'creatinina', 'bun_crea', 'fosforo', 'calcio',
        'ALT', 'Fosfatasa_Alcalina', 'billirrubina_total', 'Albumina',
        'proteinas_totales', 'Globulinas', 'alb/glo'
    ];
    
    // Aplicar la funcionalidad a cada campo
    camposNumericos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Usar keydown en lugar de input
            campo.addEventListener('keydown', function(event) {
                // Solo actuar cuando se presiona la tecla punto
                if (event.key === '.') {
                    event.preventDefault(); // Prevenir la acción por defecto
                    
                    // Obtener la posición actual del cursor
                    const cursorPos = this.selectionStart;
                    
                    // Obtener el valor actual e insertar una coma en lugar del punto
                    const valorActual = this.value;
                    const nuevoValor = valorActual.slice(0, cursorPos) + ',' + valorActual.slice(cursorPos);
                    
                    // Establecer el nuevo valor
                    this.value = nuevoValor;
                    
                    // Restaurar la posición del cursor justo después de la coma
                    setTimeout(() => {
                        this.setSelectionRange(cursorPos + 1, cursorPos + 1);
                    }, 0);
                }
            });
            
            // Mover las actualizaciones de color y cálculos al evento blur
            campo.addEventListener('blur', function() {
                actualizarColor(id, 'ref' + id.toLowerCase());
                if (id === 'Albumina' || id === 'proteinas_totales') {
                    calculateValues();
                }
            });
            
            // Eliminar cualquier evento input que pueda interferir
            const oldInputListeners = campo._inputListeners || [];
            oldInputListeners.forEach(listener => {
                campo.removeEventListener('input', listener);
            });
        }
    });
}

// Ejecutar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    reemplazarPuntoPorComa();
});
// Función para actualizar el datalist de razas según la especie seleccionada
function actualizarRazasPorEspecie() {
    const especie = document.getElementById('especieSelector').value;
    // Crear el datalist si no existe
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    } else {
        // Limpiar la lista actual
        datalistRazas.innerHTML = '';
    }
    
    const campoRaza = document.getElementById('mascotaRaza');
    
    // Restablecer el campo de raza si se cambia la especie
    if (campoRaza.value && campoRaza.value !== "SRD") {
        campoRaza.value = '';
    }
    
    // Agregar las razas según la especie seleccionada
    if (especie === "Canino") {
        razasCaninas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Felino") {
        razasFelinas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
        // Para otras especies, agregar solo opciones genéricas
        const option = document.createElement('option');
        option.value = "SRD";
        datalistRazas.appendChild(option);
    }
}

// Modificar la función existente
function actualizarEspecieEnPlantilla() {
    const especie = document.getElementById('especieSelector').value;
    document.getElementById('especieEnPlantilla').value = especie;
    document.getElementById('especieEnPlantilla2').value = especie;
    
    // Actualizar las razas disponibles según la especie
    actualizarRazasPorEspecie();
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existe el selector de especies
    const especieSelector = document.getElementById('especieSelector');
    if (especieSelector) {
        // Si ya hay una especie seleccionada al cargar
        if (especieSelector.value !== "Seleccionar") {
            actualizarRazasPorEspecie();
        }
        
        // Agregar un listener adicional para garantizar que se actualicen las razas
        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
    }
    
    // Crear datalist si no existe
    if (!document.getElementById('razas')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'razas';
        document.body.appendChild(datalist);
    }
});

function cambiarPlantilla() {
    const seleccion = document.getElementById('plantillaSelector').value;
    
    console.log("Cambiando a plantilla: " + seleccion);
    
    // Ocultar todas las plantillas
    document.getElementById('template1').style.display = 'none';
    document.getElementById('template2').style.display = 'none';
    
    // Mostrar solo la plantilla seleccionada
    document.getElementById(seleccion).style.display = 'block';
    
    // Sincronizar datos entre plantillas
    if (seleccion === 'template2') {
        sincronizarDatosHaciaSimple();
    } else if (seleccion === 'template1') {
        sincronizarDatosHaciaCompleto();
    }
}

function sincronizarDatosHaciaSimple() {
    console.log("Sincronizando datos hacia plantilla simple");
    
    document.getElementById('mascotaNombre2').value = document.getElementById('mascotaNombre').value;
    document.getElementById('mascotaRaza2').value = document.getElementById('mascotaRaza').value;
    document.getElementById('sexoEnPlantilla2').value = document.getElementById('sexoEnPlantilla').value;
    document.getElementById('especieEnPlantilla2').value = document.getElementById('especieEnPlantilla').value;
    document.getElementById('mascotaEdad2').value = document.getElementById('mascotaEdad').value;
    document.getElementById('mascotaPeso2').value = document.getElementById('mascotaPeso').value;
    
    document.getElementById('propietarioNombre2').value = document.getElementById('propietarioNombre').value;
    document.getElementById('propietarioCedula2').value = document.getElementById('propietarioCedula').value;
    document.getElementById('propietarioTelefono2').value = document.getElementById('propietarioTelefono').value;
    document.getElementById('propietarioEmail2').value = document.getElementById('propietarioEmail').value;
    document.getElementById('propietarioFecha2').value = document.getElementById('propietarioFecha').value;
    document.getElementById('nombreMedico2').value = document.getElementById('nombreMedico').value;
    
    document.getElementById('colorMacroscopico2').value = document.getElementById('colorMacroscopico').value;
    document.getElementById('consistenciaMacroscopico2').value = document.getElementById('consistenciaMacroscopico').value;
    document.getElementById('mucoMacroscopico2').value = document.getElementById('mucoMacroscopico').value;
    document.getElementById('sangreVisibleMacroscopico2').value = document.getElementById('sangreVisibleMacroscopico').value;
    document.getElementById('hallazgosMacroscopico2').value = document.getElementById('hallazgosMacroscopico').value;
    
    document.getElementById('leucocitosMicroscopico2').value = document.getElementById('leucocitosMicroscopico').value;
    document.getElementById('eritrocitosMicroscopico2').value = document.getElementById('eritrocitosMicroscopico').value;
    document.getElementById('microbiotaMicroscopico2').value = document.getElementById('microbiotaMicroscopico').value;
    document.getElementById('morfologiaMicroscopico2').value = document.getElementById('morfologiaMicroscopico').value;
    document.getElementById('levadurasMicroscopico2').value = document.getElementById('levadurasMicroscopico').value;
    document.getElementById('parasitosMicroscopico2').value = document.getElementById('parasitosMicroscopico').value;
    document.getElementById('quistesMicroscopico2').value = document.getElementById('quistesMicroscopico').value;
    document.getElementById('ooquistesMicroscopico2').value = document.getElementById('ooquistesMicroscopico').value;
    document.getElementById('huevecillosMicroscopico2').value = document.getElementById('huevecillosMicroscopico').value;
    document.getElementById('residuosMicroscopico2').value = document.getElementById('residuosMicroscopico').value;
    document.getElementById('fibrasMuscularesMicroscopico2').value = document.getElementById('fibrasMuscularesMicroscopico').value;
    document.getElementById('fibrasVegetalesMicroscopico2').value = document.getElementById('fibrasVegetalesMicroscopico').value;
    document.getElementById('almidonMicroscopico2').value = document.getElementById('almidonMicroscopico').value;
    document.getElementById('polenMicroscopico2').value = document.getElementById('polenMicroscopico').value;
    
    document.getElementById('tecnicasUsadas2').value = "Flot (S.Zinc, Sheater, Greenflix) Directo (Lugol, Salina)";
}

function sincronizarDatosHaciaCompleto() {
    console.log("Sincronizando datos hacia plantilla completa");
    
    document.getElementById('mascotaNombre').value = document.getElementById('mascotaNombre2').value;
    document.getElementById('mascotaRaza').value = document.getElementById('mascotaRaza2').value;
    document.getElementById('sexoEnPlantilla').value = document.getElementById('sexoEnPlantilla2').value;
    document.getElementById('especieEnPlantilla').value = document.getElementById('especieEnPlantilla2').value;
    document.getElementById('mascotaEdad').value = document.getElementById('mascotaEdad2').value;
    document.getElementById('mascotaPeso').value = document.getElementById('mascotaPeso2').value;
    
    document.getElementById('propietarioNombre').value = document.getElementById('propietarioNombre2').value;
    document.getElementById('propietarioCedula').value = document.getElementById('propietarioCedula2').value;
    document.getElementById('propietarioTelefono').value = document.getElementById('propietarioTelefono2').value;
    document.getElementById('propietarioEmail').value = document.getElementById('propietarioEmail2').value;
    document.getElementById('propietarioFecha').value = document.getElementById('propietarioFecha2').value;
    document.getElementById('nombreMedico').value = document.getElementById('nombreMedico2').value;
    
    document.getElementById('colorMacroscopico').value = document.getElementById('colorMacroscopico2').value;
    document.getElementById('consistenciaMacroscopico').value = document.getElementById('consistenciaMacroscopico2').value;
    document.getElementById('mucoMacroscopico').value = document.getElementById('mucoMacroscopico2').value;
    document.getElementById('sangreVisibleMacroscopico').value = document.getElementById('sangreVisibleMacroscopico2').value;
    document.getElementById('hallazgosMacroscopico').value = document.getElementById('hallazgosMacroscopico2').value;
    
    document.getElementById('leucocitosMicroscopico').value = document.getElementById('leucocitosMicroscopico2').value;
    document.getElementById('eritrocitosMicroscopico').value = document.getElementById('eritrocitosMicroscopico2').value;
    document.getElementById('microbiotaMicroscopico').value = document.getElementById('microbiotaMicroscopico2').value;
    document.getElementById('morfologiaMicroscopico').value = document.getElementById('morfologiaMicroscopico2').value;
    document.getElementById('levadurasMicroscopico').value = document.getElementById('levadurasMicroscopico2').value;
    document.getElementById('parasitosMicroscopico').value = document.getElementById('parasitosMicroscopico2').value;
    document.getElementById('quistesMicroscopico').value = document.getElementById('quistesMicroscopico2').value;
    document.getElementById('ooquistesMicroscopico').value = document.getElementById('ooquistesMicroscopico2').value;
    document.getElementById('huevecillosMicroscopico').value = document.getElementById('huevecillosMicroscopico2').value;
    document.getElementById('residuosMicroscopico').value = document.getElementById('residuosMicroscopico2').value;
    document.getElementById('fibrasMuscularesMicroscopico').value = document.getElementById('fibrasMuscularesMicroscopico2').value;
    document.getElementById('fibrasVegetalesMicroscopico').value = document.getElementById('fibrasVegetalesMicroscopico2').value;
    document.getElementById('almidonMicroscopico').value = document.getElementById('almidonMicroscopico2').value;
    document.getElementById('polenMicroscopico').value = document.getElementById('polenMicroscopico2').value;
    
    document.getElementById('tecnicasUsadas').value = document.getElementById('tecnicasUsadas2').value;
}

function toggleMorfologiaOptions2() {
    const dropdown = document.getElementById('morfologiaDropdown2');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function updateMorfologia2() {
    const checkboxes = document.querySelectorAll('#morfologiaDropdown2 input[type="checkbox"]');
    const selectedValues = [];
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedValues.push(checkbox.nextElementSibling.textContent);
        }
    });
    document.getElementById('morfologiaMicroscopico2').value = selectedValues.join(' / ');
}

// Implementación de la función configurarNavegacionCampos
function configurarNavegacionCampos() {
    console.log("Configurando navegación de campos...");
    
    // Lista de todos los campos editables en el orden de tabulación
    const camposTemplate1 = [
        'mascotaNombre', 'mascotaRaza', 'sexoEnPlantilla', 'especieEnPlantilla', 
        'mascotaEdad', 'mascotaPeso', 'propietarioNombre', 'propietarioCedula', 
        'propietarioTelefono', 'propietarioEmail', 'nombreMedico', 'propietarioFecha',
        'colorMacroscopico', 'consistenciaMacroscopico', 'mucoMacroscopico', 
        'sangreVisibleMacroscopico', 'hallazgosMacroscopico',
        'leucocitosMicroscopico', 'eritrocitosMicroscopico', 'microbiotaMicroscopico',
        'morfologiaMicroscopico', 'levadurasMicroscopico', 'parasitosMicroscopico',
        'quistesMicroscopico', 'ooquistesMicroscopico', 'huevecillosMicroscopico',
        'trofozoitossMicroscopico', 'residuosMicroscopico', 'fibrasMuscularesMicroscopico',
        'fibrasVegetalesMicroscopico', 'almidonMicroscopico', 'polenMicroscopico',
        'antigenoGiardia', 'antigenoCryptosporidium', 'tincionGram',
        'pruebaSangreOculta', 'tecnicasUsadas'
    ];
    
    const camposTemplate2 = [
        'mascotaNombre2', 'mascotaRaza2', 'sexoEnPlantilla2', 'especieEnPlantilla2', 
        'mascotaEdad2', 'mascotaPeso2', 'propietarioNombre2', 'propietarioCedula2', 
        'propietarioTelefono2', 'propietarioEmail2', 'nombreMedico2', 'propietarioFecha2',
        'colorMacroscopico2', 'consistenciaMacroscopico2', 'mucoMacroscopico2', 
        'sangreVisibleMacroscopico2', 'sangreOcultaMacroscopico2', 'hallazgosMacroscopico2',
        'leucocitosMicroscopico2', 'eritrocitosMicroscopico2', 'microbiotaMicroscopico2',
        'morfologiaMicroscopico2', 'levadurasMicroscopico2', 'parasitosMicroscopico2',
        'quistesMicroscopico2', 'ooquistesMicroscopico2', 'huevecillosMicroscopico2',
        'residuosMicroscopico2', 'fibrasMuscularesMicroscopico2', 'fibrasVegetalesMicroscopico2',
        'almidonMicroscopico2', 'polenMicroscopico2', 'comentarioMicroscopico2', 'tecnicasUsadas2'
    ];
    
    function configurarNavegacion(campos) {
        for (let i = 0; i < campos.length; i++) {
            const campo = document.getElementById(campos[i]);
            if (campo) {
                // Configurar navegación hacia el siguiente campo
                campo.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.key === 'ArrowDown') {
                        event.preventDefault();
                        const nextIndex = i + 1 < campos.length ? i + 1 : 0;
                        const nextCampo = document.getElementById(campos[nextIndex]);
                        if (nextCampo) {
                            nextCampo.focus();
                            
                            // Si es un campo de selección, seleccionar todo el texto
                            if (nextCampo.tagName.toLowerCase() === 'input' && 
                                nextCampo.type === 'text' || nextCampo.type === 'number') {
                                nextCampo.select();
                            }
                        }
                    } else if (event.key === 'ArrowUp') {
                        event.preventDefault();
                        const prevIndex = i > 0 ? i - 1 : campos.length - 1;
                        const prevCampo = document.getElementById(campos[prevIndex]);
                        if (prevCampo) {
                            prevCampo.focus();
                            
                            // Si es un campo de selección, seleccionar todo el texto
                            if (prevCampo.tagName.toLowerCase() === 'input' &&
                                prevCampo.type === 'text' || prevCampo.type === 'number') {
                                prevCampo.select();
                            }
                        }
                    }
                });
            } else {
                console.warn(`Campo ${campos[i]} no encontrado en el DOM`);
            }
        }
    }
    
    // Configurar navegación para ambas plantillas
    configurarNavegacion(camposTemplate1);
    configurarNavegacion(camposTemplate2);
    
    console.log("Navegación de campos configurada.");
}

document.addEventListener('DOMContentLoaded', function() {
    configurarNavegacionCampos();
    
    const plantillaSelector = document.getElementById('plantillaSelector');
    if (plantillaSelector) {
        console.log("Selector de plantillas encontrado");
        plantillaSelector.addEventListener('change', cambiarPlantilla);
        
        const plantillaActual = plantillaSelector.value || 'template1';
        console.log("Plantilla inicial: " + plantillaActual);
        
        document.getElementById('template1').style.display = plantillaActual === 'template1' ? 'block' : 'none';
        document.getElementById('template2').style.display = plantillaActual === 'template2' ? 'block' : 'none';
    } else {
        console.error("Error: no se encontró el selector de plantillas");
    }
    
    document.addEventListener('click', function(event) {
        const dropdown1 = document.getElementById('morfologiaDropdown');
        const input1 = document.getElementById('morfologiaMicroscopico');
        if (dropdown1 && dropdown1.style.display === 'block' && 
            event.target !== input1 && !dropdown1.contains(event.target)) {
            dropdown1.style.display = 'none';
        }
        
        const dropdown2 = document.getElementById('morfologiaDropdown2');
        const input2 = document.getElementById('morfologiaMicroscopico2');
        if (dropdown2 && dropdown2.style.display === 'block' && 
            event.target !== input2 && !dropdown2.contains(event.target)) {
            dropdown2.style.display = 'none';
        }
    });
});

function previewImage(event, previewId) {
    const preview = document.getElementById(previewId);
    const noImageText = document.getElementById(previewId === 'preview2' ? 'noImageText2' : 'noImageText2-simple');
    const file = event.target.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            if (noImageText) noImageText.style.display = 'none';
            
            // Marcar el contenedor como teniendo imagen (para el PDF)
            preview.parentElement.setAttribute('data-has-image', 'true');
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
        if (noImageText) noImageText.style.display = 'block';
        
        // Marcar el contenedor como sin imagen
        preview.parentElement.setAttribute('data-has-image', 'false');
    }
}

// Ejecutar al cargar la página para inicializar los atributos
document.addEventListener('DOMContentLoaded', function() {
    const preview1 = document.getElementById('preview2');
    const preview2 = document.getElementById('preview2-simple');
    
    if (preview1) preview1.parentElement.setAttribute('data-has-image', 'false');
    if (preview2) preview2.parentElement.setAttribute('data-has-image', 'false');
});

async function generatePDF() {
    // Mostrar el indicador de carga
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        // Verificar que jsPDF está disponible
        if (!window.jspdf || !window.jspdf.jsPDF) {
            throw new Error("La biblioteca jsPDF no está cargada correctamente");
        }
        
        const { jsPDF } = window.jspdf;
        
        // Determinar qué plantilla está actualmente visible
        const activeTemplate = document.getElementById('template1').style.display === 'block' 
            ? document.getElementById('template1') 
            : document.getElementById('template2');

        if (!activeTemplate) {
            throw new Error('No se encontró ninguna plantilla activa.');
        }

        // Verificar si hay imágenes cargadas para el análisis
        const imagePreview = activeTemplate === document.getElementById('template1') 
            ? document.getElementById('preview2') 
            : document.getElementById('preview2-simple');
        
        // Ocultar el contenedor de imagen del análisis si no hay imagen
        const imageContainer = imagePreview.parentElement;
        const imageBox = imageContainer.parentNode;
        const hasImage = imagePreview.style.display === 'block';
        
        // Guardar estado original para restaurar después
        const originalDisplay = imageBox.style.display;
        
        // Ocultar si no hay imagen
        if (!hasImage) {
            imageBox.style.display = 'none';
        }

        // Obtener el nombre de la mascota y del propietario para el nombre del archivo
        const mascotaNombre = activeTemplate === document.getElementById('template1')
            ? document.getElementById('mascotaNombre').value || 'Sin_nombre'
            : document.getElementById('mascotaNombre2').value || 'Sin_nombre';
            
        const propietarioNombre = activeTemplate === document.getElementById('template1')
            ? document.getElementById('propietarioNombre').value || 'Sin_apellido'
            : document.getElementById('propietarioNombre2').value || 'Sin_apellido';
        
        // Extraer el primer apellido (segundo elemento después de dividir por espacios)
        const nombreArray = propietarioNombre.split(' ');
        const propietarioApellido = nombreArray.length > 1 ? nombreArray[1] : nombreArray[0];

        console.log("Generando PDF para:", mascotaNombre, propietarioApellido);
        console.log("Plantilla activa:", activeTemplate.id);
        
        // Esperar a que todas las imágenes se carguen
        const images = activeTemplate.querySelectorAll('img');
        await Promise.all([...images].map(img => {
            if (img.complete) {
                return Promise.resolve();
            }
            return new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = () => {
                    console.warn(`No se pudo cargar la imagen: ${img.src}`);
                    resolve(); // Continuamos incluso si una imagen falla
                };
            });
        }));

        console.log("Imágenes cargadas, generando canvas...");
        
        // Ocultar elementos que no deben aparecer en el PDF
        const hideElements = activeTemplate.querySelectorAll('.pdf-hide');
        hideElements.forEach(el => {
            el.style.display = 'none';
        });
        
        // Generar el canvas
        const canvas = await html2canvas(activeTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        
        // Restaurar los elementos ocultos
        hideElements.forEach(el => {
            el.style.display = '';
        });
        
        // Restaurar la visibilidad original del contenedor de imagen
        if (!hasImage) {
            imageBox.style.display = originalDisplay;
        }

        console.log("Canvas generado, creando PDF...");
        
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Ajustar el tamaño de la imagen para que quepa en la página A4 con márgenes
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        const imgWidth = pageWidth - 20; // Margen de 10mm a cada lado
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Posicionar la imagen centrada en la página
        const x = 10; // 10mm desde el borde izquierdo
        const y = 10; // 10mm desde el borde superior
        
        // Verificar si la imagen es demasiado grande para una página
        if (imgHeight > pageHeight - 20) { // 20mm de margen total (10mm arriba y 10mm abajo)
            // La imagen es demasiado alta, necesitamos dividirla en varias páginas
            const ratio = canvas.width / imgWidth;
            const pageHeightInPixels = (pageHeight - 20) * ratio;
            
            let remainingHeight = canvas.height;
            let srcY = 0;
            let dstY = y;
            let pageNum = 1;
            
            while (remainingHeight > 0) {
                // Altura que cabe en esta página
                const heightForThisPage = Math.min(pageHeightInPixels, remainingHeight);
                
                // Altura proporcional para el PDF
                const heightInPdf = heightForThisPage / ratio;
                
                // Crear un canvas temporal para esta sección
                const tmpCanvas = document.createElement('canvas');
                tmpCanvas.width = canvas.width;
                tmpCanvas.height = heightForThisPage;
                
                // Dibujar la porción correspondiente de la imagen original
                const ctx = tmpCanvas.getContext('2d');
                ctx.drawImage(
                    canvas, 
                    0, srcY, canvas.width, heightForThisPage,
                    0, 0, tmpCanvas.width, tmpCanvas.height
                );
                
                // Agregar esta sección al PDF
                const imgData = tmpCanvas.toDataURL('image/jpeg', 0.95);
                
                if (pageNum > 1) {
                    pdf.addPage();
                    dstY = y;
                }
                
                pdf.addImage(imgData, 'JPEG', x, dstY, imgWidth, heightInPdf);
                
                // Actualizar para la siguiente iteración
                srcY += heightForThisPage;
                remainingHeight -= heightForThisPage;
                pageNum++;
            }
        } else {
            // La imagen cabe en una sola página
            pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        }
        
        // Determinar el tipo de análisis para el nombre del archivo
        const tipoAnalisis = activeTemplate === document.getElementById('template1') 
            ? 'Análisis Heces Completo' 
            : 'Análisis Heces General';
            
        // Generar nombre de archivo
        const fileName = `${tipoAnalisis} ${mascotaNombre} ${propietarioApellido}.pdf`;
        
        console.log("PDF creado, guardando como:", fileName);
        
        // Guardar el archivo
        pdf.save(fileName);
        
        console.log("PDF guardado exitosamente");
        
        return true;
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
        return false;
    } finally {
        // Ocultar el indicador de carga y habilitar el botón nuevamente
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}
</script>
                </tbody>
            </table>

            <h3 class="titulos">EXAMEN MACROSCÓPICO</h3>
            <table>
                <thead>
                    <tr>
                        <th>PARÁMETRO</th>
                        <th>RESULTADO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" id="colorMacroscopico"></td>
                    </tr>
                    <tr>
                        <td>Consistencia</td>
                        <td>
                            <input type="text" id="consistenciaMacroscopico" list="bristolOptions">
                            <datalist id="bristolOptions">
                                <option value="Tipo 1 Bristol">
                                <option value="Tipo 2 Bristol">
                                <option value="Tipo 3 Bristol">
                                <option value="Tipo 4 Bristol">
                                <option value="Tipo 5 Bristol">
                                <option value="Tipo 6 Bristol">
                                <option value="Tipo 7 Bristol">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Muco</td>
                        <td>
                            <input type="text" id="mucoMacroscopico" list="mucoOptions">
                            <datalist id="mucoOptions">
                                <option value="Se observa">
                                <option value="No se observa">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Sangre visible</td>
                        <td>
                            <input type="text" id="sangreVisibleMacroscopico" list="sangreVisibleOptions">
                            <datalist id="sangreVisibleOptions">
                                <option value="Se observa">
                                <option value="No se observa">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Hallazgos</td>
                        <td><input type="text" id="hallazgosMacroscopico"></td>
                    </tr>
                </tbody>
            </table>

            <h3 class="titulos">EXAMEN MICROSCÓPICO</h3>
            <table>
                <thead>
                    <tr>
                        <th>PARÁMETRO</th>
                        <th>RESULTADO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Leucocitos</td>
                        <td>
                            <input type="text" id="leucocitosMicroscopico" onblur="agregarSufijoCampo(this)">
                        </td>
                    </tr>
                    <tr>
                        <td>Eritrocitos</td>
                        <td>
                            <input type="text" id="eritrocitosMicroscopico" onblur="agregarSufijoCampo(this)">
                        </td>
                    </tr>
                    <tr>
                        <td>Microbiota bacteriana</td>
                        <td>
                            <input type="text" id="microbiotaMicroscopico" list="microbiotaOptions">
                            <datalist id="microbiotaOptions">
                                <option value="Escaso">
                                <option value="Moderado">
                                <option value="Abundante">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Morfología bacteriana</td>
                        <td>
                            <div class="morfologia-container">
                                <input type="text" id="morfologiaMicroscopico" readonly onclick="toggleMorfologiaOptions()">
                                <div id="morfologiaDropdown" class="morfologia-dropdown" style="display: none;">
                                    <div><input type="checkbox" id="morfo-cocos" onchange="updateMorfologia()"> <label for="morfo-cocos">Cocos</label></div>
                                    <div><input type="checkbox" id="morfo-bacilos" onchange="updateMorfologia()"> <label for="morfo-bacilos">Bacilos</label></div>
                                    <div><input type="checkbox" id="morfo-diplococos" onchange="updateMorfologia()"> <label for="morfo-diplococos">Diplococos</label></div>
                                    <div><input type="checkbox" id="morfo-diplobacilos" onchange="updateMorfologia()"> <label for="morfo-diplobacilos">Diplobacilos</label></div>
                                    <div><input type="checkbox" id="morfo-estreptococos" onchange="updateMorfologia()"> <label for="morfo-estreptococos">Estreptococos</label></div>
                                    <div><input type="checkbox" id="morfo-estreptobacilos" onchange="updateMorfologia()"> <label for="morfo-estreptobacilos">Estreptobacilos</label></div>
                                    <div><input type="checkbox" id="morfo-espiroquetas" onchange="updateMorfologia()"> <label for="morfo-espiroquetas">Espiroquetas</label></div>
                                </div>
                            </div>
                            <script>
                                function toggleMorfologiaOptions() {
                                    const dropdown = document.getElementById('morfologiaDropdown');
                                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                                }

                                function updateMorfologia() {
                                    const checkboxes = document.querySelectorAll('#morfologiaDropdown input[type="checkbox"]');
                                    const selectedValues = [];
                                    checkboxes.forEach(checkbox => {
                                        if (checkbox.checked) {
                                            selectedValues.push(checkbox.nextElementSibling.textContent);
                                        }
                                    });
                                    document.getElementById('morfologiaMicroscopico').value = selectedValues.join(' / ');
                                }

                                // Close dropdown when clicking elsewhere on the page
                                document.addEventListener('click', function(event) {
                                    const dropdown = document.getElementById('morfologiaDropdown');
                                    const input = document.getElementById('morfologiaMicroscopico');
                                    if (dropdown.style.display === 'block' && event.target !== input && !dropdown.contains(event.target)) {
                                        dropdown.style.display = 'none';
                                    }
                                });
                            </script>
            
                        </td>
                    </tr>
                    <tr>
                        <td>Levaduras</td>
                        <td>
                            <input type="text" id="levadurasMicroscopico" list="levadurasOptions">
                            <datalist id="levadurasOptions">
                                <option value="Se observa">
                                <option value="No se observa">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Parásitos</td>
                        <td><input type="text" id="parasitosMicroscopico"></td>
                    </tr>
                    <tr>
                        <td>Quistes</td>
                        <td><input type="text" id="quistesMicroscopico"></td>
                    </tr>
                    <tr>
                        <td>Ooquistes</td>
                        <td><input type="text" id="ooquistesMicroscopico"></td>
                    </tr>
                    <tr>
                        <td>Huevecillos</td>
                        <td><input type="text" id="huevecillosMicroscopico"></td>
                    </tr>
                    <tr>
                        <td>Trofozoitos</td>
                        <td><input type="text" id="trofozoitossMicroscopico"></td>
                    </tr>
                    <tr>
                        <td>Residuos</td>
                        <td><input type="text" id="residuosMicroscopico"></td>
                    </tr>
                    <tr>
                        <td>Fibras musculares</td>
                        <td><input type="text" id="fibrasMuscularesMicroscopico" list="fibrasMuscularesOptions">
                            <datalist id="fibrasMuscularesOptions">
                                <option value="Escaso">
                                <option value="Moderado">
                                <option value="Abundante">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Fibras vegetales</td>
                        <td><input type="text" id="fibrasVegetalesMicroscopico" list="fibrasVegetalesOptions">
                            <datalist id="fibrasVegetalesOptions">
                                <option value="Escaso">
                                <option value="Moderado">
                                <option value="Abundante">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Almidón</td>
                        <td>
                            <input type="text" id="almidonMicroscopico" list="almidonOptions">
                            <datalist id="almidonOptions">
                                <option value="Se observa">
                                <option value="No se observa">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Polen</td>
                        <td>
                            <input type="text" id="polenMicroscopico" list="polenOptions">
                            <datalist id="polenOptions">
                                <option value="Se observa">
                                <option value="No se observa">
                            </datalist>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3 class="titulos">PRUEBAS ADICIONALES</h3>
            <table>
                <thead>
                    <tr>
                        <th>PRUEBA</th>
                        <th>RESULTADO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Antígeno Giardia</td>
                        <td>
                            <input type="text" id="antigenoGiardia" list="opcionesGiardia">
                            <datalist id="opcionesGiardia">
                                <option value="Positivo">
                                <option value="Negativo">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Antígeno Cryptosporidium</td>
                        <td>
                            <input type="text" id="antigenoCryptosporidium" list="opcionesCrypto">
                            <datalist id="opcionesCrypto">
                                <option value="Positivo">
                                <option value="Negativo">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Tinción Gram</td>
                        <td>
                            <input type="text" id="tincionGram" list="opcionesGram">
                            <datalist id="opcionesGram">
                                <option value="Bacterias Gram Positivas">
                                <option value="Bacterias Gram Negativas">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Prueba Sangre Oculta</td>
                        <td>
                            <input type="text" id="pruebaSangreOculta" list="opcionesSangre">
                            <datalist id="opcionesSangre">
                                <option value="Positivo">
                                <option value="Negativo">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Técnicas Usadas</td>
                        <td>
                            <input type="text" id="tecnicasUsadas" value="Flotación, Tinción Lugol, Directo, Salina">
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Modified image section with one predefined image and one uploadable image -->
            <div class="image-container" style="display: flex; justify-content: space-between; margin: 20px 0;">
                <div class="image-box" style="flex: 1; text-align: center; margin: 0 10px;">
                    <h4>Imagen de Referencia</h4>
                    <!-- Pre-determined image -->
                    <img src="img/heces.png" alt="Escala de Bristol" style="max-width: 100%; max-height: 200px; border: 1px solid #ddd; padding: 5px;">
                </div>
                <div class="image-box" style="flex: 1; text-align: center; margin: 0 10px;">
                    <h4>Imagen del Análisis</h4>
                    <!-- This will be hidden in PDF but shown in UI -->
                    <div class="pdf-hide" style="margin-bottom: 10px;">
                        <label for="image2">Seleccionar imagen:</label>
                        <input type="file" id="image2" accept="image/*" onchange="previewImage(event, 'preview2')">
                    </div>
                    <div style="margin-top: 10px; min-height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center;">
                        <img id="preview2" alt="Imagen del Análisis" style="max-width: 100%; max-height: 200px; display: none;">
                        <span id="noImageText2" class="pdf-hide">Sin imagen</span>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
                <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
                <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
                <p>Correo: laboratorio@vetsanmartin.com</p>
            </div>
        </div>

        <!-- NUEVA PLANTILLA: Análisis de Heces Simple -->
        <div class="container" id="template2" style="display: none;">
            <div class="header">
                <img src="img/empresa.jpg" alt="Logo de la Empresa" class="small-image">
                <h1>Laboratorio Clínico Veterinario</h1>
            </div>
            <h3 class="subheader">ANÁLISIS HECES GENERAL</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre</td>
                        <td><input type="text" id="mascotaNombre2" onkeydown="moverFocoConFlechas(event, 'propietarioNombre2', 'propietarioNombre2', 'mascotaNombre2', 'mascotaRaza2')"></td>
                        <td>Nombre</td>
                        <td><input type="text" id="propietarioNombre2" onkeydown="moverFocoConFlechas(event, 'propietarioCedula2', 'mascotaNombre2', 'mascotaNombre2', 'propietarioCedula2')"></td>
                    </tr>
                    <tr>
                        <td>Raza</td>
                        <td><input type="text" id="mascotaRaza2" list="razas2" onkeydown="moverFocoConFlechas(event, 'propietarioCedula2', 'mascotaNombre2', 'mascotaNombre2', 'mascotaSexo2')"></td>
                        <datalist id="razas2"></datalist>
                        <td>Cédula</td>
                        <td><input type="text" id="propietarioCedula2" onkeydown="moverFocoConFlechas(event, 'propietarioTelefono2', 'mascotaRaza2', 'propietarioNombre2', 'propietarioTelefono2')"></td>
                    </tr>
                    <tr>
                        <td>Sexo</td>
                        <td><input type="text" id="sexoEnPlantilla2"></td>
                        <td>Teléfono</td>
                        <td><input type="text" id="propietarioTelefono2" onkeydown="moverFocoConFlechas(event, 'propietarioCedula2', 'mascotaSexo2', 'propietarioCedula2', 'propietarioEmail2')"></td>
                    </tr>
                    <tr>
                        <td>Especie</td>
                        <td><input type="text" id="especieEnPlantilla2"></td>
                        <td>Email</td>
                        <td><input type="text" id="propietarioEmail2" onkeydown="moverFocoConFlechas(event, 'mascotaEspecie2', 'mascotaEspecie2', 'propietarioTelefono2', 'nombreMedico2')"></td>
                    </tr>
                    <tr>
                        <td>Edad</td>
                        <td><input type="text" id="mascotaEdad2" list="edades"></td>
                        <td>Médico</td>
                        <td>
                            <input type="text" id="nombreMedico2" list="medicos" 
                                onkeydown="moverFocoConFlechas(event, 'propietarioFecha2', 'mascotaEdad2', 'propietarioEmail2', 'propietarioFecha2')"
                                oninput="verificarMedico()">
                        </td>
                    </tr>
                    <tr>
                        <td>Peso</td>
                        <td><input type="text" id="mascotaPeso2" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha2', 'mascotaEdad2', 'mascotaEdad2', 'mascotaPeso2')"></td>
                        <td>Fecha</td>
                        <td><input type="date" id="propietarioFecha2" class="date-input"></td>
                    </tr>
                </tbody>
            </table>

            <h3 class="titulos">EXAMEN MACROSCÓPICO</h3>
            <table>
                <thead>
                    <tr>
                        <th>PARÁMETRO</th>
                        <th>RESULTADO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Color</td>
                        <td><input type="text" id="colorMacroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Consistencia</td>
                        <td>
                            <input type="text" id="consistenciaMacroscopico2" list="bristolOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Muco</td>
                        <td>
                            <input type="text" id="mucoMacroscopico2" list="mucoOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Sangre visible</td>
                        <td>
                            <input type="text" id="sangreVisibleMacroscopico2" list="sangreVisibleOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Sangre oculta</td>
                        <td>
                            <input type="text" id="sangreOcultaMacroscopico2" list="sangreOcultaOptions">
                            <datalist id="sangreOcultaOptions">
                                <option value="Positivo">
                                <option value="Negativo">
                            </datalist>
                        </td>
                    </tr>
                    <tr>
                        <td>Hallazgos</td>
                        <td><input type="text" id="hallazgosMacroscopico2"></td>
                    </tr>
                </tbody>
            </table>

            <h3 class="titulos">EXAMEN MICROSCÓPICO</h3>
            <table>
                <thead>
                    <tr>
                        <th>PARÁMETRO</th>
                        <th>RESULTADO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Leucocitos</td>
                        <td>
                            <input type="text" id="leucocitosMicroscopico2" onblur="agregarSufijoCampo(this)">
                        </td>
                    </tr>
                    <tr>
                        <td>Eritrocitos</td>
                        <td>
                            <input type="text" id="eritrocitosMicroscopico2" onblur="agregarSufijoCampo(this)">
                        </td>
                    </tr>
                    <tr>
                        <td>Microbiota bacteriana</td>
                        <td>
                            <input type="text" id="microbiotaMicroscopico2" list="microbiotaOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Morfología bacteriana</td>
                        <td>
                            <div class="morfologia-container">
                                <input type="text" id="morfologiaMicroscopico2" readonly onclick="toggleMorfologiaOptions2()">
                                <div id="morfologiaDropdown2" class="morfologia-dropdown" style="display: none;">
                                    <div><input type="checkbox" id="morfo-cocos2" onchange="updateMorfologia2()"> <label for="morfo-cocos2">Cocos</label></div>
                                    <div><input type="checkbox" id="morfo-bacilos2" onchange="updateMorfologia2()"> <label for="morfo-bacilos2">Bacilos</label></div>
                                    <div><input type="checkbox" id="morfo-diplococos2" onchange="updateMorfologia2()"> <label for="morfo-diplococos2">Diplococos</label></div>
                                    <div><input type="checkbox" id="morfo-diplobacilos2" onchange="updateMorfologia2()"> <label for="morfo-diplobacilos2">Diplobacilos</label></div>
                                    <div><input type="checkbox" id="morfo-estreptococos2" onchange="updateMorfologia2()"> <label for="morfo-estreptococos2">Estreptococos</label></div>
                                    <div><input type="checkbox" id="morfo-estreptobacilos2" onchange="updateMorfologia2()"> <label for="morfo-estreptobacilos2">Estreptobacilos</label></div>
                                    <div><input type="checkbox" id="morfo-espiroquetas2" onchange="updateMorfologia2()"> <label for="morfo-espiroquetas2">Espiroquetas</label></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Levaduras</td>
                        <td>
                            <input type="text" id="levadurasMicroscopico2" list="levadurasOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Parásitos</td>
                        <td><input type="text" id="parasitosMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Quistes</td>
                        <td><input type="text" id="quistesMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Ooquistes</td>
                        <td><input type="text" id="ooquistesMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Huevecillos</td>
                        <td><input type="text" id="huevecillosMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Residuos</td>
                        <td><input type="text" id="residuosMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Fibras musculares</td>
                        <td><input type="text" id="fibrasMuscularesMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Fibras vegetales</td>
                        <td><input type="text" id="fibrasVegetalesMicroscopico2"></td>
                    </tr>
                    <tr>
                        <td>Almidón</td>
                        <td>
                            <input type="text" id="almidonMicroscopico2" list="almidonOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Polen</td>
                        <td>
                            <input type="text" id="polenMicroscopico2" list="polenOptions">
                        </td>
                    </tr>
                    <tr>
                        <td>Comentario</td>
                        <td>
                            <textarea id="comentarioMicroscopico2" rows="3" style="width: 100%"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>Técnicas Utilizadas</td>
                        <td>
                            <input type="text" id="tecnicasUsadas2" value="Flot (S.Zinc, Sheater, Greenflix) Directo (Lugol, Salina)">
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Añadir la sección de imágenes antes del footer en template2 -->
            <div class="image-container" style="display: flex; justify-content: space-between; margin: 20px 0;">
                <div class="image-box" style="flex: 1; text-align: center; margin: 0 10px;">
                    <h4>Imagen de Referencia</h4>
                    <!-- Pre-determined image -->
                    <img src="img/heces.png" alt="Escala de Bristol" style="max-width: 100%; max-height: 200px; border: 1px solid #ddd; padding: 5px;">
                </div>
                <div class="image-box" style="flex: 1; text-align: center; margin: 0 10px;">
                    <h4>Imagen del Análisis</h4>
                    <!-- This will be hidden in PDF but shown in UI -->
                    <div class="pdf-hide" style="margin-bottom: 10px;">
                        <label for="image2-simple">Seleccionar imagen:</label>
                        <input type="file" id="image2-simple" accept="image/*" onchange="previewImage(event, 'preview2-simple')">
                    </div>
                    <div style="margin-top: 10px; min-height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center;">
                        <img id="preview2-simple" alt="Imagen del Análisis" style="max-width: 100%; max-height: 200px; display: none;">
                        <span id="noImageText2-simple" class="pdf-hide">Sin imagen</span>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p id="mensajeMedico2" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
                <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
                <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
                <p>Correo: laboratorio@vetsanmartin.com</p>
            </div>
        </div>

        <div class="controls">
            <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
            <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
            <div id="loadingPdf" class="loading-indicator">
                <div class="spinner"></div>
                <span>Generando PDF...</span>
            </div>
        </div>
        <script>
            function agregarSufijoCampo(input) {
                // Obtener el valor actual
                let valor = input.value.trim();
                
                // Si está vacío, no hacer nada
                if (!valor) return;
                
                // Verificar si se trata del campo de leucocitos
                if (input.id === 'leucocitosMicroscopico' || input.id === 'leucocitosMicroscopico2') {
                    // Verificar si ya tiene el sufijo y el símbolo <
                    if (!valor.includes("por campo de 40x")) {
                        // Si no empieza con <, añadirlo
                        if (!valor.startsWith("<")) {
                            valor =  valor;
                        }
                        // Añadir el sufijo
                        input.value = valor + " por campo de 40x";
                    }
                } else {
                    // Para otros campos (como eritrocitos) mantener el comportamiento original
                    if (!valor.includes("por campo de 40x")) {
                        // Verificar si el valor comienza con un número
                        if (/^\d+/.test(valor)) {
                            // Añadir el sufijo
                            input.value = valor + " por campo de 40x";
                        }
                    }
                }
            }
        </script>
        <script>
            // Asegurar que el texto de técnicas utilizadas en template2 tenga el formato correcto
            document.addEventListener('DOMContentLoaded', function() {
                // Establecer el valor correcto para el campo de técnicas utilizadas en la plantilla simple
                const tecnicasUsadas2 = document.getElementById('tecnicasUsadas2');
                if (tecnicasUsadas2) {
                    tecnicasUsadas2.value = "Flot (S.Zinc, Sheater, Greenflix) Directo (Lugol, Salina)";
                }
                
                // Modificar la función de sincronización para que no sobrescriba este valor específico
                const sincOriginal = sincronizarDatosHaciaSimple;
                sincronizarDatosHaciaSimple = function() {
                    sincOriginal();
                    // Restablecer el valor correcto después de la sincronización
                    document.getElementById('tecnicasUsadas2').value = "Flot (S.Zinc, Sheater, Greenflix) Directo (Lugol, Salina)";
                };
            });
        </script>
    </body>
</body>
</html>

        </script>
    </body>
</body>
</html>
